name: static-analysis
description: |
  This workflow runs static analysis on the infrastructure code using Trivy in IaC mode.
  - Uploads SARIF results to GitHub for Code Scanning alerts (Security Tab) only on develop/main pushes.
  - Uploads SARIF results to GitHub for PR annotations on all branches.
  - Fails the check on HIGH/CRITICAL findings when targeting develop/main.
permissions:
  contents: read
  security-events: write # Necessario per la Security Tab
  pull-requests: write # Necessario per le annotazioni/check
on:
  push:
    branches:
      - develop
      - main
  pull_request:
  schedule:
    # Run daily at 2 AM UTC on develop and main branches
    - cron: '0 2 * * *'

jobs:
  trivy_scan:
    name: Infrastructure Static Analysis
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      # --- Esecuzione Scansioni SARIF (Valido per tutti i branch) ---

      - name: üõ°Ô∏è Run Trivy (SARIF)
        uses: aquasecurity/trivy-action@dc5a429b52fcf669ce959baa2c2dd26090d2a6c4
        with:
          scan-type: 'config'
          scan-ref: './src/main'
          hide-progress: true
          format: 'sarif'
          output: 'trivy-results.sarif'
          exit-code: '0'
          trivyignores: '.trivyignore'
          # Scansioniamo tutte le severity (LOW, MEDIUM, HIGH, CRITICAL) per le annotazioni PR
          # Le severity non CRITICAL/HIGH saranno filtrate per la Security Tab
          severity: 'HIGH,CRITICAL' 

      # --- Filtro e Upload per GitHub Security Tab (Solo su develop/main push) ---

      # La parte di filtro SARIF non √® pi√π necessaria. Quando carichi il SARIF, GitHub ti permette
      # di configurare le regole di Code Scanning per ignorare LOW/MEDIUM.
      # Tuttavia, se preferisci filtrare, il tuo approccio con JQ √® valido. Lo manteniamo per 
      # coerenza con il tuo file originale, concentrandoci solo sui branch principali.

      - name: üîç Filter SARIF to HIGH/CRITICAL
        run: |
          jq '
            .runs |= map(
              .results |= map(select(
                (.message.text | test("Severity: (HIGH|CRITICAL)"))
              ))
            )
          ' trivy-results.sarif > trivy-results-highcritical.sarif
      
      - name: ‚¨ÜÔ∏è Upload Trivy results to Security Tab
        if: github.event_name == 'push' && (github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main')
        uses: github/codeql-action/upload-sarif@ff0a06e83cb2de871e5a09832bc6a81e7276941f
        with:
          sarif_file: 'trivy-results-highcritical.sarif'
          category: 'trivy-infra-core'

      # --- Annotazioni PR (Universali) ---

      - name: üìù Annotate PR with Trivy results
        if: github.event_name == 'pull_request'
        uses: github/codeql-action/upload-sarif@ff0a06e83cb2de871e5a09832bc6a81e7276941f
        with:
          sarif_file: 'trivy-results-highcritical.sarif'
          category: 'trivy-pr-annotation-infra-core'

      # --- Logica di Fallimento Condizionale (Fail on HIGH/CRITICAL) ---

      # Calcoliamo il conteggio totale di HIGH/CRITICAL in un unico step per il check di fail
      - name: üî¢ Count HIGH/CRITICAL vulnerabilities
        id: count_vulnerabilities
        run: |
          total_count=$(jq '[.runs[].results[] | select(.message.text | test("Severity: (HIGH|CRITICAL)"))] | length' trivy-results-highcritical.sarif)
          
          echo "Number of HIGH/CRITICAL vulnerabilities: $total_count"
          echo "total_count=$total_count" >> $GITHUB_OUTPUT
      
      # Fail se √® una PR verso develop/main O se √® un push su develop/main (prevenendo il merge/push)
      - name: ‚ùå Fail on HIGH/CRITICAL vulnerabilities
        if: |
          (github.event_name == 'pull_request' && (github.base_ref == 'develop' || github.base_ref == 'main')) ||
          (github.event_name == 'push' && (github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'))
        run: |
          if [ "${{ steps.count_vulnerabilities.outputs.total_count }}" -ne "0" ]; then
              echo "::error::Found ${{ steps.count_vulnerabilities.outputs.total_count }} HIGH/CRITICAL vulnerabilities on branch ${{ github.ref }} or PR targeting ${{ github.base_ref }}"
              exit 1
          else
              echo "No HIGH/CRITICAL vulnerabilities found. Proceeding."
          fi